---
- name: Cluster set-up
  hosts: master:zerocluster
  become: true
  vars_files:
    - vars/vars.yml
    - vars/cluster.yml
  roles:
    - role: hostname
    - role: installpkg
      packages: "{{ apt_pkg }}"
  tasks:
    - name: Fix root permissions
      ansible.builtin.include_tasks: tasks/fixroot.yml

    - name: Configure master OS
      ansible.builtin.include_tasks: tasks/master.yml
      when: "'master' in group_names"

    - name: Add static route for zerocluster
      copy:
        src: files/zerocluster/40-route
        dest: /lib/dhcpcd/dhcpcd-hooks/40-route
        owner: root
        group: root
        mode: 0644
      when: "'zerocluster' in group_names"

    - name: Apply the route
      ansible.builtin.command: ip ro add 172.19.180.0/23 via 172.16.2.200 dev eth0
      when: "'zerocluster' in group_names"
      ignore_errors: true

    - name: Mount master share
      ansible.builtin.mount:
        path: /opt/data
        src: 172.19.180.254:/opt/data
        opts: rw,sync,hard,intr
        state: mounted
        fstype: nfs
      when: "'master' not in group_names"

    - name: Create alias file
      become_user: pi
      ansible.builtin.file:
        path: ~/.bash_aliases
        state: touch

    - name: Set up aliases
      become_user: pi
      ansible.builtin.lineinfile:
        path: ~/.bash_aliases
        line: "{{ item }}"
        state: present
      with_items:
        - 'alias ll="exa -Slhg --icons"'
        - 'alias la="exa -Slhga --icons"'
        - 'alias lt="exa -T --icons"'

    - name: Set up ssh
      ansible.builtin.include_tasks: tasks/ssh.yml

    - name: Configure munge
      ansible.builtin.include_tasks: tasks/munge.yml
      when: munge

    - name: Configure slurm
      ansible.builtin.include_tasks: tasks/slurm.yml
      when: slurm
# vim: set ft=yaml.ansible ts=4 sw=2 tw=80 et :
